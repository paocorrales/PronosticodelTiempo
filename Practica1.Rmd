---
title: "Comparación entre el Análisis del GFS y observaciones de estaciones de superficie"
subtitle: "Actividad N°1"
author: "Paola Corrales"
date: "12 de mayo de 2020"
output: 
  bookdown::pdf_document2:
    number_sections: false
toc: false
---
\renewcommand{\figurename}{Figura}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      cache = TRUE)

library(metR)
library(rNOMADS)
library(tidyverse)
library(data.table)
library(patchwork)

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

geom_mapa <- function() {
  geom_sf(data = map, fill = NA, color = "black", size = 0.2, inherit.aes = FALSE)
}

estaciones_prueba <- c("RESISTENCIA AERO", 
                       "RIO CUARTO AERO", "AEROPARQUE AERO")
```

## Estaciones meteorológicas de superficie

Para la comparación con el análisis de GFS se se descargaron las observaciones de estaciones de superficie pertenencientes al Servicio Meteorológico Nacional e incluidas en la base de datos pública (Figura \@ref(fig:obs)). Para la descarca automática se utilizó la función `GetSMNData()` del paquete `metR`.

```{r obs, warning=FALSE, fig.align="left", fig.height=4.8, fig.cap="Ubicación de las estaciones meteorológicas incluidas en el análisis"}
# meta_estaciones <- fread("estaciones_smn.txt", header = FALSE, skip = 1) %>%
#   .[, V10 := NULL] %>%
#   .[, lat := as.numeric(str_trim(paste0(V3, ".", V4), "both"))] %>%
#   .[, lon := as.numeric(str_trim(paste0(V5, ".", V6), "both"))] %>%
#   .[, c("V1", "V2", "lon", "lat", "V7", "V8", "V9")] %>%
#   setnames(c("V1", "V2", "lon", "lat", "V7", "V8", "V9"), c("nombre", "provincia", "lon", "lat", "altura", "numero", "numeroOACI")) %>%
#   fwrite("estaciones_smn.csv")

meta_estaciones <- fread("estaciones_smn.csv")

dates <- seq.Date(lubridate::ymd(20200418), lubridate::ymd(20200504), by = "1 day")
obs <- GetSMNData(dates, type = "hourly") %>% 
  setDT()

obs <- meta_estaciones[obs, on = c(nombre = "station")] %>% 
    setnames(c("t", "rh"), c("TMP", "RH")) %>% 
  .[, date := lubridate::as_datetime(date)]

obs %>% 
  unique(by = "nombre") %>% 
  ggplot(aes(lon, lat)) +
  geom_point(size = 0.8) +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-55, -22)) +
  theme_minimal()

estaciones <- na.omit(obs) %>% unique(by = c("lon", "lat"))
```

El análisis del GFS se descargó de [https://nomads.ncep.noaa.gov](https://nomads.ncep.noaa.gov) utilizando la librería `rNOMADS`. Se utilizó el análisis disponible en 2.5° a las 4 horas principales. Las variable utilizada fue la *temperatura a dos metros* que luego fue interpolada bilinealmente a la ubicación de cada estación meteorológica.

```{r gfsanl}
# url_disponible <- CrawlModels("gdas_0p25")
# purrr::map(url_disponible, function(url) {
# 
#   fecha_hora <- unglue::unglue(url, "https://nomads.ncep.noaa.gov/cgi-bin/filter_gdas_0p25.pl?dir=%2Fgdas.{fecha}%2F{hora}")
#   dir.create(paste0(getwd(), "/gdas/",fecha_hora[[1]][["fecha"]]))
#   preds <- ParseModelPage(url)$pred[1]
#   model.info <- GribGrab(url,
#                          preds,
#                          levels = c("2 m above ground"),
#                          variables = c("UGRD", "VGRD", "TMP", "RH"),
#                          local.dir = paste0(getwd(), "/gdas/",fecha_hora[[1]][["fecha"]], "/"))
# })


files <- list.files(path = "gdas/", pattern = ".grb", 
                    recursive = TRUE, full.names = TRUE)
domain <- c(285, 305, -22, -60)
gdas <- purrr::map(files, function(f) {
  model.data <- ReadGrib(f, 
                         c("2 m above ground"), 
                         variables = c("TMP", "RH"),
                         domain = domain)
  model.data <- as_tibble(model.data) %>% 
    setDT() %>% 
    .[, ":="(model.run.date = lubridate::as_datetime(model.run.date),
             forecast.date = lubridate::as_datetime(forecast.date))] %>% 
    .[, meta.data := NULL] %>% 
    .[, grib.type := NULL] %>% 
    .[, value := if_else(variables == "TMP", value -273.15, value)] %>% 
    .[]
  
}) %>% rbindlist()

obs_t_rh <- obs %>% 
  melt(measure.vars = c("TMP", "RH"))
```

```{r interp}
interp <- gdas %>% 
  .[, interp::interp(lon, lat, value,
                     xo = estaciones$lon,
                     yo = estaciones$lat,
                     output = "points"), by = .(model.run.date, variables)] %>% 
  .[obs_t_rh, on = c(y = "lat", x = "lon", 
                     model.run.date = "date", variables = "variable")] %>% 
  na.omit() %>% 
  setnames(c("x", "y", "z", "value"), c("lon", "lat", "ana", "obs"))
```

## Temperatura a 2 metros

En la Figura \@ref(fig:mapa-temp) se muestra el bias del análisis para la temperatura a dos metros para cada estación calculada para el periodos 18/04/2020 a 11/05/2020. A primera vista se observan algunas estaciones con bias por encima de 5 grados y si bien es posible, su ubicación hace pensar que hay problemas en la resolución de la topografía del modelo. 

```{r mapa-temp, fig.align="center", fig.width=4, fig.height=6, fig.cap="Bias del análisis para la temperatura a 2 metros para cada estación calculado para el periodo 18 de abril a 11 de mayo."}
interp[variables == "TMP"] %>% 
  .[, .(bias = mean(obs - ana)), by = .(nombre, variables, lon, lat)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(fill = bias, size = bias^2), shape = 21) +
  scale_fill_divergent(name = "Bias", 
                       guide = guide_colorbar(barwidth = 15,
                                              barheight = 0.7)) +
  scale_size_area(guide = "none") +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-55, -22)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```


```{r topo, fig.align="center", fig.height=3, fig.cap="Relación entre el bias en la temperatura y la diferencia de alturas del modelo y la estación. Se marcan las estaciones donde la diferencia de altura es mayor a 500 metros."}
topo <- ReadGrib("/home/pao/Documents/PronosticodelTiempo/topo.grb",
                 variables = "HGT",
                 levels = "surface",
                 domain = domain) %>% 
  as_tibble() %>% 
  setDT()

topo_estaciones <- topo %>% 
  .[, interp::interp(lon, lat, value,
                     xo = meta_estaciones$lon,
                     yo = meta_estaciones$lat,
                     output = "points")] %>% 
  .[meta_estaciones, on = c(y = "lat", x = "lon")] %>% 
  na.omit() %>% 
  setnames(c("x", "y", "z", "altura"), c("lon", "lat", "altura.modelo", "altura.estacion"))

# topo_estaciones[interp[variables == "TMP"], on = c("lon", "lat")] %>% 
#   .[, .(diff = (altura.estacion - altura.modelo)[1],
#         bias = mean(obs - ana)), by = .(nombre, lon, lat)] %>% 
#   lm(bias~I(diff/1000) - 1, data = .)
  
topo_estaciones[interp[variables == "TMP"], on = c("lon", "lat")] %>% 
  .[, .(diff = (altura.estacion - altura.modelo)[1],
        bias = mean(obs - ana)), by = .(nombre, lon, lat)] %>%   
  ggplot(aes(diff, (bias))) +
  geom_smooth(method = "lm", formula = y ~ x -1  ) +
  geom_point() +
  ggrepel::geom_label_repel(data = ~.x[diff < -500], aes(label = nombre)) +
  labs(y = "Bias (°C)",
       x = "Diferencia de altura (m)") +
  theme_minimal() 

porcentaje <- topo_estaciones[interp[variables == "TMP"], on = c("lon", "lat")] %>% 
  .[, .(bias = mean(obs - ana)), by = .(nombre, lon, lat)] %>% 
  .[, .(count = mean(bias < 0))] %>% 
  as.numeric()

```

Para analizar la diferencia de altura entre la estación y análisis debido a una mala representación de de la topográfia en el modelo, se interpoló el campo de altura geopotencial en superficie a la ubicación de las estaciones meteorológicas. La relación entre el bias de la temperatura y la diferencia de altura se muestra en la Figura \@ref(fig:topo). La diferencia de alturas en mayormente negativa, lo que indica que la topografía en el modelo sobreestima la altura real en algunas regiones. Las estaciones que en la Figura \@ref(fig:mapa-temp) muestran un bias de temperatura muy alto también están asociadas a differencias de altura grandes:

- Jujuy Aero
- Tucumán Aero
- El Bolsón Aero
- Chilecito Aero
- Catamarca Aero

Si bien la diferencia de alturas puede explicar parte del bias observado en la temperatura, posiblemente hay otros factores involucrados. Por ejemplo, el `r round(porcentaje, 2)`% de las estaciones tiene un bias negativo, esto podría indicar que el análisis sobreestima la temperatura a 2 metros. En particular, en la Figura \@ref(fig:por-hora) se muestra la distribución del bias calculado para cada hora principal y si bien se observa que las distrubuciones son aproximadamente gausianas, todas tienen una asimetría negativa. 

```{r por-hora, fig.height=3, fig.cap="Diferencia entre las obseraciones y el análisis en las estaciones donde el bias es mayor a 5 grados."}

estaciones_malas <- c("JUJUY AERO", "TUCUMAN AERO", "CATAMARCA AERO", 
                      "EL BOLSON AERO", "CHILECITO AERO")

interp[variables == "TMP"] %>% 
  .[, .(obs.ana = mean(obs - ana)), by = .(hora = hour(model.run.date), nombre)] %>% 
  ggplot(aes(obs.ana)) +
  # geom_line(aes(color = nombre, group = nombre)) +
  # geom_line(aes(y = ana, color = nombre, group = nombre), linetype = 2) +
  # geom_point(aes(color = factor(hora))) +
  geom_density(aes(color = factor(hora))) +
  scale_color_viridis_d(name = "Hora UTC") +
  # scale_x_datetime(date_breaks = "3 days", date_labels = "%b %d") +
  labs(x = "Bias (°C)",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Si se analiza la diferencia entre la temperatura observada y la temperatura del análisis para 4 estaciones a lo largo del período (Figura \@ref(fig:evolucion-temp)) se puede ver que cambia rápidamente a lo largo del tiempo. En particular durante el 24 de abril se observa un máximo en la diferencia de temperatura en la estación Río Cuarto Aero y durante el 26 de abril en la estación Resistencia Aero. De acuerdo a las observaciones en esas estaciones, se observa un cambio en la dirección del viento a 10 metros lo que podría indicar el avance de una masa de aire. Debido a que estos procesos pueden estar mal representados en el análisis o ocurrir en tiempos distintos a la realidad, esto podría explicar las diferencias observadas con las observaciones. 

```{r evolucion-temp, fig.height=4, fig.cap="Evolución de la diferencia entre la temperatura observada en 3 estaciones la temperatura obtenida del análisis en las ubicaciones de las estaciones."}
interp[variables == "TMP" & nombre %in% estaciones_prueba] %>% 
  .[, obs.ana := mean(obs - ana), by = .(model.run.date, nombre)] %>% 
  ggplot(aes(model.run.date, obs.ana)) +
  geom_line(aes(color = nombre, group = nombre)) +
  # geom_line(aes(y = ana, color = nombre, group = nombre), linetype = 2) +
  scale_color_viridis_d(name = NULL,
                        guide = guide_legend(ncol = 3)) +
  scale_x_datetime(date_breaks = "3 days", date_labels = "%b %d") +
  labs(x = "Fecha",
       y = "Diferencia en la temperatura") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

